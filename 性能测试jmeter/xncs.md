### 性能测试

#### 什么是性能测试

* 针对软件功能接口进行的专项测试，验证产品是各项指标是否满足产品需求；【多，快，好，省】

#### 常见的性能指标

* 并发量：同一时间对软件产品进行有效操作的用户数；
  * 广义：同一时间对产品进行的各种请求操作的用户量；
  * 狭义：同一时间针对产品具体单一功能进行请求的用户量；【登录、搜索、加入购物车、支付】
  * 系统用户、注册用户：系统总的用户数量；10W
  * 在线用户：一段时间内，系统同时在线的用户数；在线用户占10%-20%
  * 并发用户：同一时间进行相同请求的用户数量；通常，占在线用户的10%-15%；
* 响应时间：用户发送请求到服务器，服务器接收并处理完成返回结果，所需的时间；
  * 遵循2/5/8或1/3/5原则；通常响应时间在1s-3s之间；
  * 响应时间的构成：响应时间=网络传输时间+服务器处理时间+数据库处理时间；
  * 平均响应时间：所有用户发送请求所消耗时间的平均值：总时间/总用户
  * 50%响应时间：50%用户所需要的时间
  * 90%响应时间：90%用户所需要的时间
* TPS：每秒事务请求处理的数量；**TPS是衡量系统性能的核心指标；**
  * QPS：每秒查询的请求；事务包含若干请求；
* 吞吐量：单位时间内发送请求和接收请求的数据量；（单位KB等......）
* 吞吐率：1秒内处理发送请求和接受请求的数量；（单位KB等......）
* 资源使用率：服务器的硬件资源所占用的比例
  * CPU使用率：在服务器运行过程中CPU的使用率，通常不超过80%
  * 内存使用率：在服务器运行过程中，内存使用率，通常不超过80%

#### 性能测试分类

* 压力测试：通过不断增加负载，验证服务器所能各项指标是否正常，找到系统所能承载的最大值；
* 负载测试：通过不断调整增加负载，验证服务器的各项指标是否正常，找到系统的最佳负载值；
* 容量测试：大数据量测试；验证服务器数据量的变化对各项指标的影响；保证服务器正常运行；

#### 性能测试工具

* LoadRunner：惠普公司旗下的针对B/S和C/S架构的，功能强大的商业工具；
* Jmeter：Apache社区下的一个开源免费的基于B/S架构的轻量级性能测试工具；
* Locust：是一个基于Python的开源库；可以进行二次开发；

#### 性能测试流程

* 性能测试计划：制定性能测试开展的资源及时间安排；性能测试通常由专门的性能团队或专人-性能测试工程师负责；
* 性能需求分析：根据业务分析性能预期指标；分析适合开展性能测试的业务场景；
  * 单场景：项目中核心关键功能业务：登录、注册、搜索
  * 混合场景：由核心功能组成的业务流程：登录->搜索->加购；
* 性能数据准备：根据业务批量准备海量测试数据（用户，商品，交易等数据），数据库的存储过程造数据
* 设计性能测试用例：据性能分析的场景，设计测试用例；
  * 性能用例包含要素：编号，场景名称，性能指标，测试数据，操作过程、脚本，断言，结果
* 编写性能测试脚本：使用Badboy/JMeter工具录制、编写脚本；
  * Badboy录制业务流程，导出JMeter脚本；
  * JMeter导入脚本/编写脚本
  * 优化脚本：对脚本进行参数化，关联、断言；
* 搭建性能测试环境：重新部署一套用于性能测试的服务器环境；比如搭建LANMP；（Apache+Nginx+MySQL+PHP）；Java环境（Tomcat+Nginx+Oracle+Redis）
* 性能测试执行-分布式压测：一台控制机+多台执行机进行分布式压测；通常由1台控制机+4-5台执行机；
  * 控制机：所有性能测试脚本在控制机上，执行时统一发送指令到执行机，
  * 执行机：根据控制机发送的脚本指令，对服务器请发送请求；
* 性能监控-监控服务器（Nmon），监控数据库（Monyog）；
  * Linux系统安装Nmon，Monyog，执行命令监控服务器运行；
* 测试结果数据收集分析
  * 进行多轮压测，收集整理测试数据，汇总对比；
* 性能瓶颈分析-性能调优
  * 对收集的性能测试结果数据，导入曲线拐点模型，分析性能瓶颈；
  * 开发进行性能瓶颈优化-代码优化-数据库SQL优化；
* 再次压测-根据调优结果，再次进行压力测试；
* 性能测试总结-生成测试报告

#### Jmeter工具的使用

* 添加取样器：
  * HTTP请求：接口的请求：基于HTTP协议发送请求；
  * FTP请求：基于FTP协议，进行文件上传下载；
  * TCP请求：基于TCP协议，进行网络连接请求；
  * JAVA请求：基于Serveice协议，进行服务访问；
  * JDBC请求：基于Socket协议，进行数据库连接；
